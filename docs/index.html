<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>DeployGuard Dashboard</title>
    <style>
        :root {
            --bg: #f8f9fa;
            --card: #ffffff;
            --muted: #6c757d;
            --accent: #007bff;
            --ok: #28a745;
            --warn: #ffc107;
            --fail: #dc3545;
            --shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            --radius: 0.5rem;
            --maxw: 1200px;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg);
            color: #212529;
            padding: 2rem;
        }

        .wrap {
            max-width: var(--maxw);
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        h1 {
            font-size: 2rem;
            margin: 0;
        }

        .sub {
            color: var(--muted);
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .card {
            background: var(--card);
            border-radius: var(--radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }

        .label {
            font-weight: 600;
            color: var(--muted);
            margin-bottom: 1rem;
        }

        .pill {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 50rem;
            font-weight: 700;
            color: #fff;
        }

        .ok {
            background: var(--ok);
        }

        .fail {
            background: var(--fail);
        }

        .warn {
            background: var(--warn);
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div>
            <h1>DeployGuard Dashboard</h1>
            <div class="sub">Live status, audit and recent changes for your portfolio</div>
        </div>
        <div class="sub">Repository: <span id="repo-name">unknown</span></div>
    </header>

    <div id="loading" class="spinner"></div>
    <div id="error" class="card fail" style="display:none;">
        <strong>Error loading health.json</strong>
        <pre id="error-details" style="margin-top:1rem;"></pre>
    </div>

    <div id="main" class="grid" style="display:none;">
        <div id="left-column"></div>
        <div id="right-column"></div>
    </div>
</div>

<script>
    const API_URL = './health.json';

    const App = {
        elements: {
            repoName: document.getElementById('repo-name'),
            loading: document.getElementById('loading'),
            error: document.getElementById('error'),
            errorDetails: document.getElementById('error-details'),
            main: document.getElementById('main'),
            leftColumn: document.getElementById('left-column'),
            rightColumn: document.getElementById('right-column'),
        },

        async fetchHealth() {
            try {
                const response = await fetch(`${API_URL}?_=${Date.now()}`, {cache: 'no-store'});
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                this.render(data);
            } catch (error) {
                this.showError(error);
            }
        },

        showError(error) {
            this.elements.loading.style.display = 'none';
            this.elements.error.style.display = 'block';
            this.elements.errorDetails.textContent = error.message || String(error);
        },

        render(data) {
            this.elements.loading.style.display = 'none';
            this.elements.main.style.display = 'grid';
            this.elements.repoName.textContent = data.repo || data.repository || 'unknown';

            this.elements.leftColumn.innerHTML = '';
            this.elements.rightColumn.innerHTML = '';

            this.renderCard(this.elements.leftColumn, 'Deployment', this.renderDeployment(data.deployed));
            this.renderCard(this.elements.leftColumn, 'Verification', this.renderVerification(data.verification));
            this.renderCard(this.elements.leftColumn, 'Audit', this.renderAudit(data.audit));

            this.renderCard(this.elements.rightColumn, 'Recent Changes', this.renderRecentChanges(data.recent_changes));
            this.renderCard(this.elements.rightColumn, 'Server', this.renderServer(data.server));
        },

        renderCard(container, title, content) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<div class="label">${title}</div>${content}`;
            container.appendChild(card);
        },

        renderDeployment(deployed) {
            return `
                <p><strong>Digest:</strong> ${deployed.digest || '—'}</p>
                <p><strong>Commit:</strong> ${deployed.commit || '—'}</p>
                <p><strong>Author:</strong> ${deployed.author || '—'}</p>
            `;
        },

        renderVerification(verification) {
            const status = verification.status || 'not configured';
            const pillClass = status.toLowerCase().includes('ok') ? 'ok' : (status.toLowerCase().includes('fail') ? 'fail' : 'warn');
            return `<p><span class="pill ${pillClass}">${status}</span></p>`;
        },

        renderAudit(audit) {
            const counts = audit.counts || {};
            const running = counts.running ?? 0;
            const stopped = counts.stopped ?? 0;
            const dangling = counts.dangling ?? 0;
            return `
                <p><strong>Running:</strong> ${running}</p>
                <p><strong>Stopped:</strong> ${stopped}</p>
                <p><strong>Dangling:</strong> ${dangling}</p>
            `;
        },

        renderRecentChanges(recentChanges) {
            const commits = recentChanges.commits || [];
            if (commits.length === 0) {
                return '<p>No recent commits found.</p>';
            }
            return `
                <ul>
                    ${commits.map(c => `<li><code>${c.hash}</code> ${this.escapeHtml(c.message)} <span class="sub">(${this.escapeHtml(c.author)})</span></li>`).join('')}
                </ul>
            `;
        },

        renderServer(server) {
            return `
                <p><strong>Host:</strong> ${server.host || '—'}</p>
                <p><strong>OS:</strong> ${server.os || '—'}</p>
                <p><strong>Docker:</strong> ${server.docker_version || '—'}</p>
            `;
        },

        escapeHtml(s) {
            if (!s) return '';
            return s.replace(/[&<>"']/g, m => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'}[m]));
        },

        init() {
            this.fetchHealth();
            setInterval(() => this.fetchHealth(), 5 * 60 * 1000);
        }
    };

    App.init();
</script>
</body>
</html>
